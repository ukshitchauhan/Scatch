<%- include('./partials/header') %>

<% if(success.length>0){ %>
        <div id="flash-message" class="absolute top-20 left-1/2 -translate-x-1/2 p-4 rounded-lg bg-blue-600/20 border border-blue-500 text-blue-400 shadow-lg backdrop-blur-md z-50 flex items-center gap-2">
            <i class="ri-checkbox-circle-line text-lg"></i>
            <span class="font-medium"><%= success %></span>
        </div>
    <% } %>

    <% if(error.length>0){ %>
        <div id="flash-message" class="absolute top-20 left-1/2 -translate-x-1/2 p-4 rounded-lg bg-red-600/20 border border-red-500 text-red-400 shadow-lg backdrop-blur-md z-50 flex items-center gap-2">
            <i class="ri-error-warning-line text-lg"></i>
            <span class="font-medium"><%= error %></span>
        </div>
    <% } %>

<div class="min-h-screen bg-black text-white selection:bg-purple-500 selection:text-white pt-10 pb-20">
    <div class="container mx-auto px-4 md:px-8 lg:px-12">

        <div class="mb-8 border-b border-zinc-800 pb-4 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-zinc-100">Shopping Bag</h1>
                <p class="text-zinc-500 text-sm mt-1">Review your selected items.</p>
            </div>
            <div class="text-zinc-500 text-sm font-medium">
                <%= user.cart.length %> Items
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 relative">

            <div class="w-full lg:w-72 shrink-0 lg:sticky lg:top-24 self-start">
                
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6 flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-zinc-800 flex items-center justify-center border border-zinc-700 overflow-hidden">
                        <% if (user.picture) { %>
                            <img src="<%= user.picture %>" alt="<%= user.fullname %>" class="w-full h-full object-cover">
                        <% } else { %>
                            <i class="ri-user-3-line text-3xl text-zinc-500"></i>
                        <% } %>
                    </div>
                    <div class="overflow-hidden">
                        <h2 class="font-bold text-lg truncate" title="<%= user.fullname %>"><%= user.fullname %></h2>
                        <p class="text-sm text-zinc-500 truncate" title="<%= user.email %>"><%= user.email %></p>
                    </div>
                </div>

                <nav class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden">
                    <div class="flex flex-col text-sm">
                        <a href="/users/profile" class="flex items-center gap-3 px-6 py-4 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200 transition-colors border-l-[3px] border-transparent">
                            <i class="ri-dashboard-line text-lg"></i>
                            Dashboard Overview
                        </a>
                        <a href="/users/orders" class="flex items-center gap-3 px-6 py-4 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200 transition-colors border-l-[3px] border-transparent">
                            <i class="ri-box-3-line text-lg"></i>
                            My Orders
                        </a>
                        
                        <a href="/users/cart" class="flex items-center gap-3 px-6 py-4 bg-zinc-800/50 text-purple-400 border-l-[3px] border-purple-500 font-medium">
                            <i class="ri-shopping-cart-line text-lg"></i>
                            Cart
                        </a>
                        
                       
                        <a href="/users/settings" class="flex items-center gap-3 px-6 py-4 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200 transition-colors border-l-[3px] border-transparent">
                            <i class="ri-settings-4-line text-lg"></i>
                            Settings
                        </a>
                        <a href="/users/logout" class="flex items-center gap-3 px-6 py-5 text-red-400 hover:bg-red-950/30 hover:text-red-300 transition-colors border-t border-zinc-800 mt-2">
                            <i class="ri-logout-box-r-line text-lg"></i>
                            Logout
                        </a>
                    </div>
                </nav>
            </div>

            <div class="flex-grow">

                <% if(user.cart.length === 0){ %>
                    
                    <div class="bg-zinc-900 border border-zinc-800 rounded-xl w-full h-80 flex flex-col items-center justify-center text-zinc-500">
                        <div class="w-16 h-16 bg-zinc-800 rounded-full flex items-center justify-center mb-4 border border-zinc-700">
                            <i class="ri-shopping-bag-3-line text-2xl opacity-50"></i>
                        </div>
                        <p class="text-lg font-medium text-zinc-300">Your bag is empty.</p>
                        <p class="text-sm text-zinc-500 mb-6">Looks like you haven't added anything yet.</p>
                        <a href="/shop" class="px-6 py-2.5 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-all shadow-lg shadow-purple-900/20">
                            Continue Shopping
                        </a>
                    </div>

                <% } else { %>

                    <div class="flex flex-col xl:flex-row gap-8">
                        
                        <div class="w-full xl:w-[65%] flex flex-col gap-4">
                            <% let total = 0; %>
                            <% let totalDiscount = 0; %>

                            <% user.cart.forEach(item => { 
                                const product = item.product;
                                if(!product) return;
                                
                                const originalPrice = product.price;
                                const finalPrice = Math.floor(product.price - (product.price * product.discount / 100));
                                const itemTotal = finalPrice * item.quantity;
                                
                                total += itemTotal;
                                totalDiscount += (originalPrice - finalPrice) * item.quantity;
                            %>

                                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 flex gap-4 group transition-all hover:border-zinc-700">
                                    
                                    <div class="w-24 h-24 sm:w-28 sm:h-28 bg-zinc-800 rounded-lg overflow-hidden flex-shrink-0 border border-zinc-700">
                                        <img class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                                             src="<%= product.image %>" 
                                             alt="<%= product.name %>">
                                    </div>

                                    <div class="flex-grow flex flex-col justify-between">
                                        <div class="flex justify-between items-start gap-4">
                                            <div>
                                                <h3 class="font-bold text-zinc-200 text-lg leading-tight"><%= product.name %></h3>
                                                <p class="text-xs text-zinc-500 uppercase tracking-wide mt-1"><%= product.category %></p>
                                            </div>
                                            <div class="text-right">
                                                <span class="font-bold text-white block">₹<%= finalPrice %></span>
                                                <% if(product.discount > 0) { %>
                                                    <span class="text-xs text-zinc-600 line-through">₹<%= product.price %></span>
                                                <% } %>
                                            </div>
                                        </div>

                                        <div class="flex justify-between items-end mt-2">
                                            <div class="flex items-center gap-3 bg-zinc-950/50 rounded-lg px-3 py-1.5 border border-zinc-800">
                                                <span class="text-xs text-zinc-500 uppercase font-bold">Qty</span>
                                                <span class="text-sm font-bold text-zinc-200"><%= item.quantity %></span>
                                            </div>

                                            <a href="/users/cart/remove/<%= product._id %>" 
                                               class="flex items-center gap-2 text-xs font-medium text-zinc-500 hover:text-red-400 transition-colors px-2 py-1">
                                                <i class="ri-delete-bin-line text-lg"></i>
                                                <span class="hidden sm:inline">Remove</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>

                            <% }) %>
                        </div>

                        <div class="w-full xl:w-[35%]">
                            <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 sticky top-24">
                                <h2 class="text-lg font-bold mb-6 text-zinc-100 border-b border-zinc-800 pb-4">Order Summary</h2>
                                
                                <div class="space-y-4 mb-6">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-zinc-400">Subtotal</span>
                                        <span class="text-zinc-200 font-medium">₹<%= total + totalDiscount %></span>
                                    </div>
                                    
                                    <% if(totalDiscount > 0) { %>
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-zinc-400">Discount</span>
                                            <span class="text-purple-400 font-medium">- ₹<%= totalDiscount %></span>
                                        </div>
                                    <% } %>

                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-zinc-400">Delivery</span>
                                        <span class="text-green-400 font-medium">Free</span>
                                    </div>
                                </div>

                                <div class="border-t border-zinc-800 pt-4 mb-6">
                                    <div class="flex justify-between items-end">
                                        <span class="text-sm text-zinc-400">Total Amount</span>
                                        <span class="text-2xl font-bold text-white tracking-tight">₹<%= total %></span>
                                    </div>
                                </div>

                                <a href="/users/checkout" 
                                   class="block w-full bg-white text-black hover:bg-purple-500 hover:text-white text-center py-3.5 rounded-lg font-bold text-sm transition-all shadow-lg hover:shadow-purple-900/20">
                                    Proceed to Checkout
                                </a>
                                
                                <div class="text-center mt-4 flex items-center justify-center gap-2 text-zinc-600">
                                    <i class="ri-lock-2-line text-xs"></i>
                                    <p class="text-[10px] uppercase tracking-wider font-bold">Secure Checkout</p>
                                </div>
                            </div>
                        </div>

                    </div>
                <% } %>

            </div>
        </div>
    </div>
</div>

<%- include('./partials/footer') %>